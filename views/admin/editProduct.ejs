<style>
  .image-upload-slot {
    background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' stroke='%23e5e7eb' stroke-width='2' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
  }

  .error {
    color: red;
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }

  .border-error {
    border-color: red !important;
  }
</style>
<div class="max-w-4xl mx-auto">
  <div class="mb-6">
    <h1 class="font-bold mb-10 text-2xl">Edit Product</h1>
  </div>
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <form id="productForm" class="p-8" action="/admin/product/edit/<%= product._id %>" method="POST"
      enctype="multipart/form-data">
    
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">Basic Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
            <input type="text" name="name" id="productName" value="<%= product.name %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div id="productNameError" class="error"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Product Description</label>
            <input type="text" name="description" id="productDescription" value="<%= product.description %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div id="productDescriptionError" class="error"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
            <select name="category" id="category"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
              <% categories.forEach(category=> { %>
                <option value="<%= category._id %>" <%=category._id.toString()===(product.category ?
                  product.category.toString() : product.categoryId.toString()) ? "selected" : "" %>>
                  <%= category.name?.toUpperCase() %>
                </option>
                <% }) %>
            </select>
            <div id="categoryError" class="error"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
            <input type="text" name="brand" id="brand" value="<%= product.brand %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div id="brandError" class="error"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Price</label>
            <input type="number" name="price" id="price" value="<%= product.basePrice %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div id="priceError" class="error"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Discount (%)</label>
            <input type="number" name="discount" id="discount" value="<%= product.discountPercentage %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div id="discountError" class="error"></div>
          </div>
        </div>
      </div>

      <!-- Product Images -->
      <!-- Product Images -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">Product Images (Exactly 4)</h2>
        <div id="imageError" class="error mb-4"></div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="imageGrid">
          <!-- Existing Images (from Cloudinary) -->
          <% product.images.forEach((img, idx)=> { %>
            <div class="relative existing-image">
              <img src="<%= img.url %>" class="w-full h-full object-cover rounded-lg" alt="Product image <%= idx+1 %>">
              <!-- Keep public_id so backend knows which one to delete -->
              <input type="hidden" name="existingImages[<%= idx %>]" value="<%= img.public_id %>">
              <button type="button"
                class="replace-image absolute top-2 right-2 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded hover:bg-blue-600">
                Replace
              </button>
              <div class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                <span class="text-white text-xs font-bold">
                  <%= idx+1 %>
                </span>
              </div>
            </div>
            <% }) %>
      
              <!-- Empty slots (if < 4) -->
              <% for(let i=product.images.length; i < 4; i++) { %>
                <div
                  class="relative image-upload-slot rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors">
                  <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                  </div>
                  <span class="text-xs text-gray-500 text-center">Add Image</span>
                  <input type="file" name="images[]" accept="image/*" class="hidden">
                  <div class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-xs font-bold">
                      <%= i+1 %>
                    </span>
                  </div>
                </div>
                <% } %>
        </div>
      </div>

      <!-- Product Variants -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold text-gray-900">Product Variants</h2>
          <button type="button"
            class="add-variant-btn px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 transition-colors">
            Add Variant
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="text-left py-3 px-4">Size</th>
                <th class="text-left py-3 px-4">Additional Price</th>
                <th class="text-left py-3 px-4">Stock</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="variantsTable">
              <% variants.forEach(variant=> { %>
                <tr class="border-b border-gray-100">
                  <td class="py-4 px-4">
                    <input name="size[]" placeholder="Nil" type="text" value="<%= variant.size %>"
                      class="w-full px-3 py-2 border rounded-md">
                      <input type="hidden" name="variantId[]" value="<%= variant._id %>">
                    <div class="error"></div>
                  </td>
                  <td class="py-4 px-4">
                    <input name="additionalPrice[]" type="number" value="<%= variant.additionalPrice %>"
                      class="w-full px-3 py-2 border rounded-md">
                    <div class="error"></div>
                  </td>
                  <td class="py-4 px-4">
                    <input name="stock[]" type="number" value="<%= variant.stock %>"
                      class="w-full px-3 py-2 border rounded-md">
                    <div class="error"></div>
                  </td>
                  <td class="py-4 px-4">
                    <button type="button" class="remove-variant text-red-500 hover:text-red-700">Remove</button>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex items-center justify-end space-x-4 pt-6 border-t">
        <a href="/admin/product"><button type="button"
            class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border rounded-md">Cancel</button></a>
        <button type="submit"
          class="px-6 py-2 text-sm font-medium text-white bg-yellow-500 rounded-md hover:bg-yellow-600">Update
          Product</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal -->
<div id="cropModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-70 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl max-w-[90%] max-h-[90%] flex flex-col items-center overflow-auto">
    <!-- Cropping Image -->
    <div class="w-full max-h-[70vh] flex justify-center mb-4">
      <img id="cropImage" class="max-w-full max-h-full rounded-lg" />
    </div>
    <!-- Buttons -->
    <div class="flex gap-3">
      <button id="cancelCropBtn" type="button"
        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium rounded-lg transition">
        Cancel
      </button>
      <button id="cropBtn" type="button"
        class="px-5 py-2 bg-yellow-400 hover:bg-yellow-500 text-black font-semibold rounded-lg transition">
        Crop & Use
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('productForm');
    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    const cropBtn = document.getElementById('cropBtn');
    const cancelCropBtn = document.getElementById('cancelCropBtn');
    const variantsTbody = document.getElementById('variantsTable');
    const addVariantBtn = document.querySelector('.add-variant-btn');

    let cropper = null;
    let currentInput = null;

    /* --------------------------------------------------------------
       VALIDATION
    -------------------------------------------------------------- */
    const nameRegex = /^(?=.*[A-Za-z])[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$/;

    function validateForm() {
      let isValid = true;
      let imageCount = 0;                     // <-- LOCAL counter

      // clear previous errors
      document.querySelectorAll('.error').forEach(el => el.textContent = '');
      document.querySelectorAll('input, select').forEach(el => el.classList.remove('border-error'));

      /* ----- Basic fields ----- */
      const productName = document.getElementById('productName');
      if (!productName.value.trim()) {
        setError('productNameError', 'Product name is required');
        isValid = false;
      } else if (!nameRegex.test(productName.value)) {
        setError('productNameError', 'Only letters/numbers allowed');
        isValid = false;
      }

      const description = document.getElementById('productDescription');
      if (!description.value.trim()) {
        setError('productDescriptionError', 'Description is required');
        isValid = false;
      }

      const category = document.getElementById('category');
      if (!category.value) {
        setError('categoryError', 'Select a category');
        isValid = false;
      }

      const brand = document.getElementById('brand');
      if (!brand.value.trim()) {
        setError('brandError', 'Brand is required');
        isValid = false;
      } else if (!nameRegex.test(brand.value)) {
        setError('brandError', 'Only letters/numbers allowed');
        isValid = false;
      }

      const price = document.getElementById('price');
      if (!price.value || price.value <= 0) {
        setError('priceError', 'Price must be > 0');
        isValid = false;
      }

      const discount = document.getElementById('discount');
      if (discount.value && (discount.value < 0 || discount.value > 100)) {
        setError('discountError', 'Discount 0-100');
        isValid = false;
      }

      /* ----- IMAGES ----- */
      // 1. Existing images that still have a hidden value
      document.querySelectorAll('.existing-image input[type="hidden"]').forEach(h => {
        if (h.value.trim()) imageCount++;
      });

      // 2. New / replaced uploads
      document.querySelectorAll('.image-upload-slot input[type="file"]').forEach(inp => {
        if (inp.files && inp.files.length) imageCount++;
      });

      if (imageCount < 4) {
        document.getElementById('imageError').textContent = 'Upload at least 4 images';
        isValid = false;
      }

      /* ----- VARIANTS ----- */
      document.querySelectorAll('#variantsTable tr').forEach(row => {
        const size = row.querySelector('input[name="size[]"]');
        const addP = row.querySelector('input[name="additionalPrice[]"]');
        const stock = row.querySelector('input[name="stock[]"]');

        const sizeE = row.querySelector('td:nth-child(1) .error');
        const addPE = row.querySelector('td:nth-child(2) .error');
        const stockE = row.querySelector('td:nth-child(3) .error');

        if (size.value.trim() && !nameRegex.test(size.value.trim())) {
          sizeE.textContent = 'Only letters/numbers';
          size.classList.add('border-error');
          isValid = false;
        }

        if (!addP.value || addP.value < 0) {
          addPE.textContent = '≥ 0';
          addP.classList.add('border-error');
          isValid = false;
        }

        if (!stock.value || stock.value < 0 || !Number.isInteger(+stock.value)) {
          stockE.textContent = 'Whole number ≥ 0';
          stock.classList.add('border-error');
          isValid = false;
        }
      });

      return isValid;
    }

    function setError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      const input = el.closest('div').querySelector('input, select');
      if (input) input.classList.add('border-error');
    }

    /* --------------------------------------------------------------
       FORM SUBMIT
    -------------------------------------------------------------- */
    form.addEventListener('submit', e => {
      if (!validateForm()) e.preventDefault();
    });

    /* --------------------------------------------------------------
       IMAGE UPLOAD / REPLACE / CROP
    -------------------------------------------------------------- */
  function initSlot(slot) {
      const input = slot.querySelector('input[type="file"]');
      if (!input) return;

      slot.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') return; // ignore replace btn
        input.click();
      });

      input.addEventListener('change', () => {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = ev => {
          cropImage.src = ev.target.result;
          currentInput = input;
          cropModal.style.display = 'flex';
          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 1, autoCropArea: 0.8 });
        };
        reader.readAsDataURL(file);
      });
    }

    // init all empty slots
    document.querySelectorAll('.image-upload-slot').forEach(initSlot);

    /* --------------------------------------------------------------
       REPLACE BUTTON (existing image → upload slot)
    -------------------------------------------------------------- */
    document.querySelectorAll('.replace-image').forEach(btn => {
      btn.addEventListener('click', () => {
        const container = btn.closest('.existing-image');
        const hidden = container.querySelector('input[type="hidden"]');
        const badge = container.querySelector('.absolute.-top-2.-right-2');

        // 1. Convert to upload slot
        container.className = 'relative image-upload-slot rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors';
        container.innerHTML = `
          <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
          </div>
          <span class="text-xs text-gray-500 text-center">Add Image</span>
        `;

        // 2. Create file input with correct name: replaceImages[idx]
        const idx = hidden.name.match(/\d+/)[0];
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.name = `replaceImages[${idx}]`;
        fileInput.classList.add('hidden');
        container.appendChild(fileInput);

        // 3. Keep hidden public_id (will be empty → backend deletes old)
        hidden.value = ''; // mark for deletion
        container.appendChild(hidden);

        // 4. Re-attach badge
        if (badge) container.appendChild(badge);

        // 5. Init new slot
        initSlot(container);
        validateForm();
      });
    });

    /* --------------------------------------------------------------
       CROP & USE
    -------------------------------------------------------------- */
    cropBtn.addEventListener('click', () => {
      if (!cropper || !currentInput) return;

      const canvas = cropper.getCroppedCanvas({ width: 800, height: 800 });
      canvas.toBlob(blob => {
        const slot = currentInput.closest('.image-upload-slot') || currentInput.closest('.existing-image');
        const badge = slot.querySelector('.absolute.-top-2.-right-2');

        // Show cropped preview
        slot.innerHTML = `<img src="${URL.createObjectURL(blob)}" class="w-full h-full object-cover rounded-lg">`;
        slot.appendChild(currentInput);
        if (badge) slot.appendChild(badge);

        // Replace file
        const newFile = new File([blob], currentInput.files[0]?.name || 'cropped.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer();
        dt.items.add(newFile);
        currentInput.files = dt.files;

        closeCropModal();
        validateForm();
      }, 'image/jpeg', 0.95);
    });

    /* --------------------------------------------------------------
       CANCEL CROP
    -------------------------------------------------------------- */
    const closeCropModal = (clear = false) => {
      cropModal.style.display = 'none';
      if (cropper) { cropper.destroy(); cropper = null; }

      if (clear && currentInput) {
        const slot = currentInput.closest('.image-upload-slot');
        const badge = slot.querySelector('.absolute.-top-2.-right-2');

        slot.innerHTML = `
          <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
          </div>
          <span class="text-xs text-gray-500 text-center">Add Image</span>
        `;
        slot.appendChild(currentInput);
        if (badge) slot.appendChild(badge);
        currentInput.value = '';
        validateForm();
      }
    };

    cancelCropBtn.addEventListener('click', () => closeCropModal(true));
    cropModal.addEventListener('click', e => { if (e.target === cropModal) closeCropModal(true); });
    window.addEventListener('keydown', e => { if (e.key === 'Escape' && cropModal.style.display === 'flex') closeCropModal(true); });

    /* --------------------------------------------------------------
       VALIDATION – IMAGE COUNT
    -------------------------------------------------------------- */
    function countImages() {
      let count = 0;

      // 1. Existing images with public_id
      document.querySelectorAll('input[name^="existingImages["]').forEach(h => {
        if (h.value.trim()) count++;
      });

      // 2. New/replaced uploads
      document.querySelectorAll('input[type="file"]').forEach(inp => {
        if (inp.files && inp.files.length > 0) count++;
      });

      return count;
    }

    window.validateForm = function () {
      // ... (keep your existing validation for name, price, etc.)

      const imageCount = countImages();
      const imageError = document.getElementById('imageError');
      if (imageCount !== 4) {
        imageError.textContent = `Please provide exactly 4 images (currently ${imageCount})`;
        return false;
      } else {
        imageError.textContent = '';
      }

      // ... rest of validation
      return true;
    };

    // Re-run on any change
    imageGrid.addEventListener('change', validateForm);
    imageGrid.addEventListener('click', e => {
      if (e.target.matches('.replace-image')) setTimeout(validateForm, 50);
    });

    // Initial call
    validateForm();
  });
</script>