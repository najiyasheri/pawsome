<link rel="stylesheet" href="/styles/auth.css" />

<div class="min-h-screen flex items-center justify-center bg-white">



    <div class="auth-container w-full max-w-md bg-white p-6 rounded-lg shadow-md">
        <img src="/img/arrow_back_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.png" alt="back-arrow" class="back-arrow" />
        <h1 class="otp-title">Verify With Your Email</h1>
        <p class="otp-subtitle">
            The One-Time Password sends to the Account
            <span class="highlight-email">
                <%=email %>
            </span>. please Enter your OTP.
        </p>

        <form action="/otp" method="POST" class="auth-form">
            <input type="hidden" name="email" value="<%= email %>">
            <input type="number" name="otp" class="otp-field" placeholder="ENTER OTP" maxlength="6"
                oninput="if(this.value.length > 6) this.value = this.value.slice(0,6);" />

            <% if (typeof error !=="undefined" ) { %>
                <p class="otp-error" style="color:red; margin-top:5px;">
                    <%= error %>
                </p>
                <% } %>
                  
                            <div class="auth-actions">
                                <button type="submit" class="primary-btn">Verify</button>

                            </div>
        </form>
    <div class="resend-otp">
        <button id="resendBtn" class="resendButton" disabled>
            Resend OTP <span id="timer">in 00:30</span>
        </button>
        <p id="resendMessage" style="margin-top: 8px; font-size: 14px;"></p>
    </div>



    </div>
</div>
<script>
    // This comes from backend session â†’ NEVER resets on refresh!
    let COOLDOWN_UNTIL = "<%= cooldownUntil %>"; // e.g., 1731268000000

    let timerInterval;
    const btn = document.getElementById('resendBtn');
    const timerSpan = document.getElementById('timer');
    const msg = document.getElementById('resendMessage');
    const email = "<%= email %>";

    function updateTimer() {
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((COOLDOWN_UNTIL - now) / 1000));

        if (remaining > 0) {
            btn.disabled = true;
            const secs = String(remaining).padStart(2, '0');
            timerSpan.textContent = `in 00:${secs}`;
            btn.innerHTML = `Resend OTP <span id="timer">in 00:${secs}</span>`;
        } else {
            btn.disabled = false;
            timerSpan.textContent = '';
            btn.innerHTML = 'Resend OTP';
            clearInterval(timerInterval);
        }
    }

    // Start timer
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);

    // Resend with fetch
    btn.addEventListener('click', async () => {
        btn.disabled = true;
        btn.innerHTML = 'Sending...';

        try {
            const res = await fetch('/resend-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await res.json();

            if (data.success) {
                msg.style.color = 'green';
                msg.textContent = 'New OTP sent!';

                // Update cooldown from server response
                COOLDOWN_UNTIL = data.cooldownUntil;
                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                msg.style.color = 'red';
                msg.textContent = data.message || 'Failed';
                btn.disabled = false;
                btn.innerHTML = 'Resend OTP';
            }
        } catch (err) {
            console.log(err)
            msg.style.color = 'red';
            msg.textContent = 'Network error';
            btn.disabled = false;
            btn.innerHTML = 'Resend OTP';
        }
    });
</script>