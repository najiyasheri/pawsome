<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drift-zoom/dist/drift-basic.min.css" />
<script src="https://cdn.jsdelivr.net/npm/drift-zoom/dist/Drift.min.js"></script>

<style>
  input.hide-arrows::-webkit-outer-spin-button,
  input.hide-arrows::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input.hide-arrows[type=number] {
    -moz-appearance: textfield;
  }

  .variant-box.selected {
    border-color: #FBBF24;
    background-color: #FEF9C3;
  }

  .stock-status {
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 500;
    display: inline-block;
  }

  .stock-good {
    background-color: #DCFCE7;
    color: #166534;
  }

  .stock-low {
    background-color: #FEF3C7;
    color: #92400E;
  }

  .stock-none {
    background-color: #FEE2E2;
    color: #991B1B;
  }

  .btn-disabled {
    background-color: #E5E7EB !important;
    color: #6B7280 !important;
    cursor: not-allowed !important;
    opacity: 0.6;
  }
</style>
<!-- Breadcrumbs -->
<nav class="text-sm text-gray-600 mb-4">
  <% breadcrumbs.forEach((crumb, index)=> { %>
    <% if (crumb.url) { %>
      <a href="<%= crumb.url %>" class="hover:text-yellow-500">
        <%= crumb.name %>
      </a>
      <% if (index < breadcrumbs.length - 1) { %>
        <span class="mx-2 text-gray-400">›</span>
        <% } %>
          <% } else { %>
            <span class="text-gray-800 font-semibold">
              <%= crumb.name %>
            </span>
            <% } %>
              <% }) %>
</nav>

<div class="max-w-7xl mx-auto px-4 py-8">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
    <!-- Left: Product Images -->
    <div>
      <div class="relative border border-gray-100 rounded-lg overflow-visible group cursor-zoom-in">
        <button class="absolute top-3 right-3 text-gray-400 favorite-btn"  data-in-wishlist="<%= isInWishlist %>">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
            class="w-6 h-6 heart-icon <%= isInWishlist ? 'text-red-500' : 'text-gray-400 hover:text-red-500' %>"
            viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
             2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09 
             C13.09 3.81 14.76 3 16.5 3 
             19.58 3 22 5.42 22 8.5 
             c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
          </svg>
        </button>
        <img id="mainImage" src="<%= product.images[0].url %>" data-zoom="<%= product.images[0].url %>"
          alt="<%= product.name %>" class="w-full h-[400px] object-contain" />
      </div>
      <div class="flex gap-3 mt-4">
        <% product.images.forEach(img=> { %>
          <img src="<%= img.url %>"
            class="w-20 h-20 border rounded-md cursor-pointer hover:ring-2 hover:ring-gray-500"
            onclick="updateMainImage('/Uploads/<%= img %>')" alt="<%= product.name %> thumbnail">
          <% }) %>
      </div>
    </div>

    <!-- Right: Product Details -->
     
    <div>
      <h1 class="text-2xl font-bold mb-2">
        <%= product.name %>
      </h1>


      <!-- Rating -->
      <div class="flex items-center gap-2 mb-4">
        <% for (let i=0; i < Math.floor(product.rating); i++) { %>
          <span class="text-yellow-400 text-lg">★</span>
          <% } %>
            <span class="font-semibold">
              <%= product.rating %>
            </span>
            <span class="text-gray-500 text-sm">(<%= product.reviews.length %> reviews)</span>
      </div>

      <!-- Price -->
      <div class="flex items-center gap-3 mb-4">
        <span id="productPrice" class="text-2xl font-bold text-black-600">₹<%= product.price %></span>
        <span id="productOldPrice" class="line-through text-gray-400">₹<%= product.oldPrice %></span>
        <span id="productDiscount" class="text-yellow-400 font-medium">
          <%= product.discount %>% OFF
        </span>
      </div>

      <!-- Variant Selection -->
      <% if(product.variants[0].size !=='Nil' ) {%>
        <div class="mb-4">
          <label class="font-medium mb-2 block">Size:</label>
          <div id="variantContainer" class="flex gap-3 flex-wrap">
            <% product.variants.forEach((variant, index)=> { %>

              <button type="button" class="variant-box px-4 py-2 border rounded-lg cursor-pointer focus:outline-none transition-all
                  <% if (variant.stock <= 0) { %>
                    border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed opacity-60
                  <% } else if (index === 0) { %>
                    selected border-yellow-400
                  <% } else { %>
                    border-gray-300 hover:border-yellow-400
                  <% } %>" data-id="<%= variant._id %>" data-additional-price="<%= variant.additionalPrice %>"
                data-is-in-cart="<%= product.variantsInCart.includes(variant._id.toString()) %>"
                data-final-price="<%= variant.finalPrice %>" data-stock="<%= variant.stock %>" <%=variant.stock <=0
                ? 'disabled' : '' %>>
                <span class="block font-medium">
                  <%= variant.size %>
                </span>
                <% if (variant.stock <=0) { %>
                  <span class="block text-sm text-red-500 font-medium">Out of stock</span>
                  <% } %>
              </button>
              <% }) %>
          </div>
          <span id="stockStatus" class="mt-1 block text-sm"></span>
        </div>

        <% }else{ %>
          <button type="button" class="variant-box hidden" <% let variant=product.variants[0]%>
            data-id="<%= variant._id %>" data-additional-price="<%= variant.additionalPrice %>"
                data-is-in-cart="<%= product.variantsInCart.includes(variant._id.toString()) %>"
                  data-final-price="<%= variant.finalPrice %>" data-stock="<%= variant.stock %>" <%=variant.stock <=0
                        ? 'disabled' : '' %>>
          </button>
          <% } %>

            <!-- Product Actions -->
            <div class="flex gap-4 mb-6">

              <!-- ✅ Add to cart (dynamic) -->
              <div id="cartContainer">
                <input type="hidden" id="productId" value="<%= product._id %>">
                <input type="hidden" id="variantId" value="<%= product.variants[0]?._id %>">

                <button type="button" id="addToCartBtn" class="px-6 py-3 rounded-xl w-40 transition-all
                  <%= product.variants[0]?.stock <= 0
                    ? 'bg-red-200 text-red-500 cursor-not-allowed'
                    : 'bg-yellow-500 hover:bg-yellow-600 shadow-md' %>" data-stock="<%= product.variants[0]?.stock %>"
                  <%=product.variants[0]?.stock <=0 ? 'disabled' : '' %>>
                  <%= product.variants[0]?.stock <=0 ? 'Out of Stock' : 'Add to Cart' %>
                </button>
              </div>


            </div>



            <!-- Description -->
            <div class="prose max-w-none text-gray">
              <h2 class="font-bold text-lg mb-2">About this item</h2>
              <p>
                <%= product.description %>
              </p>
            </div>
    </div>
  </div>

  <!-- Related Products -->
<!-- Related Products -->
<div class="mt-12">
  <% if (relatedProducts.length> 0) { %>
    <h2 class="text-xl font-bold mb-4">Related Products</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
      <% relatedProducts.forEach(rp=> { %>
        <div class="w-full bg-white border border-gray-200 rounded-lg shadow-sm relative flex flex-col">
          <!-- Favorite Button -->
          <button class="absolute top-3 right-3 text-gray-400 hover:text-red-500 favorite-btn"
            data-in-wishlist="<%= rp.isInWishlist %>" data-product-id="<%= rp._id %>"
            data-variant-id="<%= rp.selectedVariant._id %>">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
              class="w-6 h-6 heart-icon <%= rp.isInWishlist ? 'text-red-500' : 'text-gray-400 hover:text-red-500' %>"
              viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
                     2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09 
                     C13.09 3.81 14.76 3 16.5 3 
                     19.58 3 22 5.42 22 8.5 
                     c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
            </svg>
          </button>
          <!-- Product Image -->
          <a href="/product/<%= rp._id %>">
            <img class="p-6 rounded-t-lg h-40 w-full object-contain"
              src="/Uploads/<%= (rp.images && rp.images.length > 0) ? rp.images[0] : '/default.jpg' %>"
              alt="<%= rp.name %>" />
          </a>
          <!-- Content -->
          <div class="px-5 pb-5 flex flex-col flex-1">
            <!-- Product Name -->
            <a href="/product/<%= rp._id %>">
              <h5 class="text-sm font-semibold tracking-tight text-gray-900 line-clamp-2 h-12 leading-relaxed">
                <%= rp.name %>
              </h5>
            </a>
            <!-- Rating -->
            <div class="flex items-center mt-2 mb-2">
              <span class="text-yellow-400 text-sm">★</span>
              <span class="text-gray-800 text-xs font-semibold px-2 py-0.5 rounded-sm">5.0</span>
            </div>
            <!-- Price & Add to Cart / Go to Cart -->
            <div class="mt-auto flex items-center justify-between">
              <div>
                <span class="text-xl font-bold text-black-600">₹<%= rp.price %></span>
                <span class="line-through text-gray-400">₹<%= rp.oldPrice %></span>
              </div>
              <div class="cart-container">
                <input type="hidden" name="productId" value="<%= rp._id %>">
                <input type="hidden" name="variantId" value="<%= rp.selectedVariant._id %>">
                <button type="button"
                  class="cart-btn text-gray-900 font-medium rounded-lg text-xs px-3 py-1.5 text-center <%= rp.isInCart ? 'bg-yellow-600 text-black  hover:bg-yellow-700' : rp.stock <= 0 ? 'bg-red-200 text-red-500 cursor-not-allowed' : 'bg-yellow-400 hover:bg-yellow-500' %> focus:ring-4 focus:outline-none focus:ring-yellow-300"
                  data-product-id="<%= rp._id %>" data-variant-id="<%= rp.selectedVariant._id %>"
                  data-in-cart="<%= rp.isInCart %>" data-stock="<%= rp.stock %>" <%=rp.stock <=0 ? 'disabled' : '' %>>
                  <%= rp.isInCart ? 'Go to Cart' : rp.stock <=0 ? 'Out of Stock' : 'Add to Cart' %>
                </button>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
    </div>
    <% } %>
</div>

  <!-- Reviews -->
<section class="bg-gray-50 max-w-[90%] mx-auto rounded-2xl shadow-sm my-10">
  <div class="py-20 flex-col">
    <div class="w-full max-w-6xl px-4 md:px-6 mx-auto">
      <h2 class="font-manrope font-bold text-4xl text-gray-900 mb-10 text-center">
        Our Customer Reviews
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-10 pb-10 border-b border-gray-200 max-w-4xl mx-auto">
        <!-- Left: Rating Distribution -->
        <div class="flex flex-col gap-y-5 w-full">
          <!-- 5 Star -->
          <div class="flex items-center w-full">
            <p class="font-medium text-lg text-gray-900 mr-1">5</p>
            <svg width="20" height="20" fill="#FBBF24" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M9.10326 2.31699C9.47008 1.57374 10.5299 1.57374 10.8967 2.31699L12.7063 5.98347C12.8519 6.27862 13.1335 6.48319 13.4592 6.53051L17.5054 7.11846C18.3256 7.23765 18.6531 8.24562 18.0596 8.82416L15.1318 11.6781C14.8961 11.9079 14.7885 12.2389 14.8442 12.5632L15.5353 16.5931C15.6754 17.41 14.818 18.033 14.0844 17.6473L10.4653 15.7446C10.174 15.5915 9.82598 15.5915 9.53466 15.7446L5.91562 17.6473C5.18199 18.033 4.32456 17.41 4.46467 16.5931L5.15585 12.5632C5.21148 12.2389 5.10393 11.9079 4.86825 11.6781L1.94038 8.82416C1.34687 8.24562 1.67438 7.23765 2.4946 7.11846L6.54081 6.53051C6.86652 6.48319 7.14808 6.27862 7.29374 5.98347L9.10326 2.31699Z" />
            </svg>
            <p class="h-2 w-full rounded-3xl bg-gray-100 ml-5 mr-3 overflow-hidden">
              <span class="h-full rounded-3xl bg-amber-400 block" style="width: 60%"></span>
            </p>
            <p class="font-medium text-lg text-gray-900">989</p>
          </div>

          <!-- 4 Star -->
          <div class="flex items-center w-full">
            <p class="font-medium text-lg text-gray-900 mr-1">4</p>
            <svg width="20" height="20" fill="#FBBF24" viewBox="0 0 20 20">
              <path d="M9.10326 2.31699C9.47008 1.57374 10.5299 1.57374 10.8967 2.31699L12.7063 5.98347..." />
            </svg>
            <p class="h-2 w-full rounded-3xl bg-gray-100 ml-5 mr-3 overflow-hidden">
              <span class="h-full rounded-3xl bg-amber-400 block" style="width: 25%"></span>
            </p>
            <p class="font-medium text-lg text-gray-900">302</p>
          </div>

          <!-- 3 Star -->
          <div class="flex items-center w-full">
            <p class="font-medium text-lg text-gray-900 mr-1">3</p>
            <svg width="20" height="20" fill="#FBBF24" viewBox="0 0 20 20">
              <path d="M9.10326 2.31699C9.47008 1.57374 10.5299 1.57374 10.8967 2.31699L12.7063 5.98347..." />
            </svg>
            <p class="h-2 w-full rounded-3xl bg-gray-100 ml-5 mr-3 overflow-hidden">
              <span class="h-full rounded-3xl bg-amber-400 block" style="width: 10%"></span>
            </p>
            <p class="font-medium text-lg text-gray-900">126</p>
          </div>

          <!-- 2 Star -->
          <div class="flex items-center w-full">
            <p class="font-medium text-lg text-gray-900 mr-1">2</p>
            <svg width="20" height="20" fill="#FBBF24" viewBox="0 0 20 20">
              <path d="M9.10326 2.31699C9.47008 1.57374 10.5299 1.57374 10.8967 2.31699L12.7063 5.98347..." />
            </svg>
            <p class="h-2 w-full rounded-3xl bg-gray-100 ml-5 mr-3 overflow-hidden">
              <span class="h-full rounded-3xl bg-amber-400 block" style="width: 3%"></span>
            </p>
            <p class="font-medium text-lg text-gray-900">42</p>
          </div>

          <!-- 1 Star -->
          <div class="flex items-center w-full">
            <p class="font-medium text-lg text-gray-900 mr-1">1</p>
            <svg width="20" height="20" fill="#FBBF24" viewBox="0 0 20 20">
              <path d="M9.10326 2.31699C9.47008 1.57374 10.5299 1.57374 10.8967 2.31699L12.7063 5.98347..." />
            </svg>
            <p class="h-2 w-full rounded-3xl bg-gray-100 ml-5 mr-3 overflow-hidden">
              <span class="h-full rounded-3xl bg-amber-400 block" style="width: 2%"></span>
            </p>
            <p class="font-medium text-lg text-gray-900">19</p>
          </div>
        </div>

        <!-- Right: Average Rating -->
        <div
          class="p-6 bg-white rounded-3xl flex flex-col items-center justify-center transition-all duration-300 hover:scale-[1.03] shadow-sm">
          <div class="flex items-center gap-3 mb-4">
            <h2 class="font-manrope font-bold text-5xl text-amber-500">4.3</h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#FBBF24" viewBox="0 0 44 44">
              <path d="M21.1033 2.9166C21.4701 2.17335 22.5299 2.17335 22.8967 2.9166L28.233 13.729..." />
            </svg>
          </div>
          <p class="font-medium text-xl text-gray-700 text-center">
            Based on 1,478 Ratings
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

</div>

<script>


  const variantButtons = document.querySelectorAll('.variant-box');
  const productPrice = document.getElementById('productPrice');
  const productOldPrice = document.getElementById('productOldPrice');
  const productDiscount = document.getElementById('productDiscount');
  const stockStatus = document.getElementById('stockStatus');
  const addToCartBtn = document.getElementById('addToCartBtn');
  const variantIdInput = document.getElementById('variantId');
  const productIdInput = document.getElementById('productId');

  const basePrice = parseFloat('<%= product.basePrice %>');
  const discount = parseFloat('<%= product.discount %>');

  function setAddToCartState(isInCart, stock) {
    isCartMode = isInCart;

    if (isInCart) {
      addToCartBtn.textContent = 'Go to Cart';
      addToCartBtn.className = 'px-6 py-3 rounded-xl w-40 bg-yellow-600 text-gray-900  hover:bg-yellow-700 cursor-pointer';
      addToCartBtn.disabled = false;
    } else {
      updateAddToCartButton(stock);
    }
  }

  const firstVariant = variantButtons[0];
  setAddToCartState(firstVariant?.dataset?.isInCart === 'true', parseInt(firstVariant?.dataset?.stock));

  variantButtons?.forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;

      variantButtons?.forEach(v => v.classList.remove('selected'));
      btn.classList.add('selected');

      const stock = parseInt(btn.dataset.stock);
      const price = parseFloat(btn.dataset.finalPrice);
      const variantId = btn?.dataset?.id;
      const isInCart = btn.dataset.isInCart === 'true';

      variantIdInput.value = variantId;
      productPrice.textContent = `₹${price.toFixed(0)}`;

      updateStockStatus(stock);
      setAddToCartState(isInCart, stock);
    });
  });

  // Update stock message
  function updateStockStatus(stock) {
    stockStatus.className = 'mt-1 block text-sm';
    if (stock === 0) {
      stockStatus.textContent = 'Out of Stock';
      stockStatus.classList.add('text-red-500');
    } else if (stock <= 5) {
      stockStatus.textContent = `Only ${stock} left!`;
      stockStatus.classList.add('text-yellow-500');
    } else {
      stockStatus.textContent = '';
    }
  }

  // Update Add to Cart button state
  function updateAddToCartButton(stock) {
    if (stock <= 0) {
      addToCartBtn.disabled = true;
      addToCartBtn.textContent = 'Out of Stock';
      addToCartBtn.className = 'px-6 py-3 rounded-xl w-40 bg-red-200 text-red-500 cursor-not-allowed';
    } else {
      addToCartBtn.disabled = false;
      addToCartBtn.textContent = 'Add to Cart';
      addToCartBtn.className = 'px-6 py-3 rounded-xl w-40 bg-yellow-500 hover:bg-yellow-600 shadow-md  text-black';
    }
  }


  // Single event listener that handles both modes
  addToCartBtn?.addEventListener('click', async () => {
    if (isCartMode) {
      window.location.href = '/cart';
      return;
    }

    // Otherwise, add to cart
    const productId = productIdInput.value;
    const variantId = variantIdInput.value;

    if (!variantId) {
      alert('Please select a variant!');
      return;
    }

    addToCartBtn.disabled = true;
    addToCartBtn.textContent = 'Adding...';

    try {
      const response = await fetch('/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json',"Accept": "application/json" },
        body: JSON.stringify({ productId, variantId })
      });

      // Handle 401 Unauthorized before reading JSON
      if (response.status === 401) {
        Swal.fire({
          icon: 'warning',
          title: 'Login Required',
          text: 'Please login to add items to your cart.',
          confirmButtonText: 'Go to Login',
          confirmButtonColor: '#facc15', // yellow
          showCancelButton: true,
          cancelButtonText: 'Cancel',
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/login';
          }
        });
         addToCartBtn.disabled = false;
        addToCartBtn.textContent = 'Add to Cart';
        return; // stop further execution
      }

      const result = await response.json();

      if (result.success) {
        setAddToCartState(true, result.stock);

        const currentVariant = document.querySelector(`.variant-box[data-id="${variantId}"]`);
        if (currentVariant) {
          currentVariant.dataset.isInCart = 'true';
        }

        Swal.fire({
          icon: 'success',
          title: 'Added to Cart!',
          text: 'The product has been successfully added to your cart.',
          showConfirmButton: false,
          timer: 1500
        });
      } else {
        addToCartBtn.disabled = false;
        addToCartBtn.textContent = 'Add to Cart';

        Swal.fire({
          icon: 'warning',
          title: 'Oops!',
          text: result.message || 'Failed to add to cart.',
          confirmButtonColor: '#facc15',
        });
      }
    } catch (error) {
      console.error('Add to cart error:', error);
      addToCartBtn.disabled = false;
      addToCartBtn.textContent = 'Add to Cart';

      Swal.fire({
        icon: 'error',
        title: 'Something went wrong!',
        text: 'Please try again later.',
        confirmButtonColor: '#f87171',
      });
    } finally {
      addToCartBtn.disabled = false;
    }

  });


  function updateMainImage(src) {
    const mainImage = document.getElementById('mainImage');
    mainImage.src = src;
    mainImage.dataset.zoom = src;
    initDrift();
  }

  let driftInstance = null;

  function initDrift() {
    const mainImg = document.getElementById('mainImage');
    const container = document.querySelector('.group');
    if (!mainImg || !container) return;

    if (driftInstance) {
      driftInstance.disable();
      driftInstance = null;
    }

    driftInstance = new Drift(mainImg, {
      paneContainer: container,
      inlinePane: false,
      hoverBoundingBox: true,
      sourceAttribute: 'data-zoom',
      paneOffsetX: 16,
      zoomFactor: 2.5,
      paneHeight: 400
    });
  }
  const mainImg = document.getElementById('mainImage');
  if (mainImg.complete) {
    initDrift();
  } else {
    mainImg.addEventListener('load', initDrift, { once: true });
  }
  // WISHLIST BUTTON HANDLER
  const wishlistButtons = document.querySelectorAll(".favorite-btn");

    wishlistButtons.forEach(favBtn => {
      // Read initial state
      let inWishlist = favBtn.dataset.inWishlist === 'true';

      favBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        // Get product and variant IDs dynamically
        const productId = favBtn.closest('[data-product-id]')?.dataset.productId ||
          document.getElementById("productId")?.value;
        const variantId = favBtn.closest('[data-variant-id]')?.dataset.variantId ||
          document.getElementById("variantId")?.value;

        try {
          const response = await fetch(
            inWishlist
              ? `/wishlist/remove/${productId}`
              : `/wishlist/add/${productId}${variantId ? `/${variantId}` : ''}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json",
                "Accept": "application/json"
               }
            }
          );

          if (response.status === 401) {
            Swal.fire({
              icon: "warning",
              title: "Login Required",
              text: "Please login to manage your wishlist.",
              confirmButtonText: "Go to Login",
              confirmButtonColor: "#facc15",
              showCancelButton: true,
              cancelButtonText: "Cancel",
            }).then((result) => {
              if (result.isConfirmed) window.location.href = "/login";
            });
            return;
          }

          const result = await response.json();

          if (result.success) {
            inWishlist = !inWishlist;
            favBtn.dataset.inWishlist = inWishlist;

            const heartIcon = favBtn.querySelector(".heart-icon");
            if (inWishlist) heartIcon.classList.add("text-red-500");
            else heartIcon.classList.remove("text-red-500");

            Swal.fire({
              icon: inWishlist ? "success" : "info",
              title: inWishlist ? "Added to Wishlist!" : "Removed from Wishlist",
              showConfirmButton: false,
              timer: 1500,
            });
          }

        } catch (error) {
          console.error("Wishlist error:", error);
          Swal.fire({
            icon: "error",
            title: "Something went wrong!",
            text: "Unable to update wishlist. Please try again later.",
            confirmButtonColor: "#f87171",
          });
        }
      });
    });


  // ... (Existing JavaScript for variant selection, image zoom, wishlist, etc.)

        // Handle Related Products Add to Cart
        const cartButtons = document.querySelectorAll('.cart-btn');

  cartButtons.forEach(btn => {
          btn.addEventListener('click', async () => {
            if (btn.disabled) return;

            const productId = btn.getAttribute('data-product-id');
            const variantId = btn.getAttribute('data-variant-id');
            const isInCart = btn.getAttribute('data-in-cart') === 'true';
            const stock = parseInt(btn.getAttribute('data-stock'));

            if (isInCart) {
              window.location.href = '/cart';
              return;
            }

            if (stock <= 0) {
              Swal.fire({
                icon: 'warning',
                title: 'Out of Stock',
                text: 'This product is currently out of stock.',
                confirmButtonColor: '#f87171',
              });
              return;
            }

            btn.disabled = true;
            btn.textContent = 'Adding...';

            try {
              const response = await fetch('/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json',
                  "Accept": "application/json"
                 },
                body: JSON.stringify({ productId, variantId })
              });

              console.log("response:",response)

              if (response.status === 401) {
                Swal.fire({
                  icon: 'warning',
                  title: 'Login Required',
                  text: 'Please login to add items to your cart.',
                  confirmButtonText: 'Go to Login',
                  confirmButtonColor: '#facc15',
                  showCancelButton: true,
                  cancelButtonText: 'Cancel',
                }).then((result) => {
                  if (result.isConfirmed) {
                    window.location.href = '/login';
                  }
                });
                btn.disabled = false;
                btn.textContent = 'Add to Cart';
                return;
              }

              const result = await response.json();

              if (result.success) {
                btn.textContent = 'Go to Cart';
                btn.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700', 'text-black');
                btn.setAttribute('data-in-cart', 'true');
                btn.disabled = false;

                Swal.fire({
                  icon: 'success',
                  title: 'Added to Cart!',
                  text: 'The product has been successfully added to your cart.',
                  showConfirmButton: false,
                  timer: 1500
                });
              } else {
                btn.disabled = false;
                btn.textContent = 'Add to Cart';
                Swal.fire({
                  icon: 'warning',
                  title: 'Oops!',
                  text: result.message || 'Failed to add to cart.',
                  confirmButtonColor: '#facc15',
                });
              }
            } catch (error) {
              console.error('Add to cart error:', error);
              btn.disabled = false;
              btn.textContent = 'Add to Cart';
              Swal.fire({
                icon: 'error',
                title: 'Something went wrong!',
                text: 'Please try again later.',
                confirmButtonColor: '#f87171',
              });
            }
          });
  });



</script>